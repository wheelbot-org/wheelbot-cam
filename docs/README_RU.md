# Wheelb⚙t.org Cam

Модуль камеры для проекта Wheelbot.org.

## Обзор

Прошивка для ESP32-CAM обеспечивает потоковую передачу видео на удаленный сервер через WiFi. Модуль поддерживает автоматическую настройку через captive portal и конфигурацию параметров камеры.

| | |
|-|-|
| ![configuration](./captive_portal_01.jpg) | ![save settings](./captive_portal_02.jpg) |

## Основные возможности

- **Видеостриминг**: Непрерывная передача JPEG кадров через HTTP multipart
- **Captive Portal**: Настройка WiFi и параметров через веб-интерфейс
- **Автоматическое восстановление**: Reconnect с exponential backoff (5с → 60с макс)
- **mDNS**: Обнаружение устройства по имени `wheelbot-cam.local`
- **Модульная архитектура**: Четкое разделение ответственности
- **Гибкая конфигурация**: Управление уровнем логирования через platformio.ini
- **Оптимизация производительности**: Передача владения фреймами, атомарные операции, настраиваемое ограничение FPS
- **Эффективное использование памяти**: Устранены утечки памяти, правильное управление буферами кадров

## Быстрый старт

1. Подключите питание к ESP32-CAM
2. Подключитесь к WiFi сети "Wheelbot-Cam-Setup"
3. Откройте браузер (captive portal откроется автоматически)
4. Выберите вашу WiFi сеть и введите пароль
5. Настройте параметры камеры:
   - IP адрес сервера стриминга
   - Порт сервера
   - Размер кадра (от QQVGA до UXGA)
   - JPEG качество (10-63)
6. Нажмите "Save & Connect"
7. Устройство начнет стриминг на сервер

### Индикация состояния

- **Светодиод горит** - идет стрим.
- **Светодиод быстро мигает** - потеряно соединение с сервером, идут попытки переподключения.
- **Светодиод медленно мигнул 10 раз и погас** - плата переведена в режим точки доступа и ожидает настройки.

#### Хранение настроек

Все настройки сохраняются в ESP32 NVS (Non-Volatile Storage):
- **Namespace**: `wheelbot-cam`
- **Параметры**: ssid, password, server_ip, server_port, frame_size, jpeg_quality
- **Поддерживаемые размеры кадра**: QQVGA (160x120), QVGA (320x240), VGA (640x480), SVGA (800x600), XGA (1024x768), SXGA (1280x1024)

## Конфигурация

### Настройки стриминга (StreamConfig.h)

| Параметр | Тип | По умолчанию | Описание |
|-----------|-----|--------------|-----------|
| `maxFPS` | uint32_t | 30 | Максимальное количество кадров в секунду (0 = без ограничения) |
| `taskQueueSize` | size_t | 8 | Количество кадров в очереди (увеличить для медленных сетей) |
| `taskStackDepth` | size_t | 4096 | Размер стека задачи TaskSender |
| `taskPriority` | uint32_t | 5 | Приоритет задачи TaskSender (1-24) |
| `taskDelayMs` | uint32_t | 1 | Задержка между отправкой кадров |
| `bufferSize` | size_t | 16384 | Размер буфера HTTP клиента |
| `txBufferSize` | size_t | 8192 | Размер TX буфера HTTP клиента |
| `reconnectInterval` | uint32_t | 5000 | Начальная задержка реконнекта (мс) |
| `maxReconnectInterval` | uint32_t | 60000 | Максимальная задержка реконнекта (мс) |
| `reconnectMultiplier` | float | 2.0 | Множитель экспоненциального backoff |
| `metricsUpdateInterval` | uint32_t | 1000 | Интервал логирования метрик (мс) |
| `slowChunkThreshold` | uint32_t | 50 | Порог предупреждения для медленной отправки (мс) |
| `chunkSize` | size_t | 4096 | Размер чанка для стриминга |

**Рекомендуемые настройки**:

- **Стабильный WiFi**: `maxFPS=30, taskQueueSize=8`
- **Нестабильный WiFi**: `maxFPS=15, taskQueueSize=16`
- **Быстрая сеть**: `maxFPS=0 (без ограничений), taskQueueSize=8`
- **Медленная сеть**: `maxFPS=10, taskQueueSize=12`

## Прошивка

```bash
# Очищаем плату
pio run -t erase

# Сборка прошивки
pio run

# Загрузка файловой системы (веб-интерфейс)
pio run -t uploadfs

# Загрузка прошивки на устройство
pio run -t upload
```

## Уровни дебага

Прошивка использует встроенную систему логирования ESP-IDF, управляемую флагом `CORE_DEBUG_LEVEL` в файле `platformio.ini`:

### Таблица уровней логирования

| Уровень | Значение | Режим | Отображаемые логи |
|----------|----------|---------|-------------------|
| **Продакшн** | 0 | NONE | Нет логов |
| **Только ошибки** | 1 | ERROR | ESP_LOGE |
| **Предупреждения** | 2 | WARN | ESP_LOGW, ESP_LOGE |
| **Разработка** | 3 | INFO | ESP_LOGI, ESP_LOGW, ESP_LOGE |
| **Отладка** | 4 | DEBUG | ESP_LOGD, ESP_LOGI, ESP_LOGW, ESP_LOGE |
| **Verbose** | 5 | VERBOSE | Все логи включая ESP_LOGV |

### Мониторинг логов

Для мониторинга логов через Serial:

```bash
pio device monitor
```

## Поддерживаемые модели камер

По умолчанию настроена модель: **AI Thinker ESP32-CAM**

Другие поддерживаемые модели:
- ESP32 WROVER KIT
- ESP EYE
- M5STACK с PSRAM (V2, WIDE, UnitCAM)
- TTGO T-Camera
- XIAO ESP32S3
- ESP32S3 CAM LCD
- ESP32S2 CAM BOARD
- ESP32S3 EYE
- DFRobot FireBeetle2 / Romeo ESP32S3

## Устранение неполадок

| Проблема | Решение |
|-----------|----------|
| Не подключается к WiFi | Убедитесь, что captive portal открыт (SSID: "Wheelbot-Cam-Setup") |
| Нет стриминга | Проверьте IP сервера и порт в настройках |
| Медленная передача | Проверьте сеть. Подключите внешнюю антену. Уменьшите размер кадра или увеличьте JPEG качество (меньшее число) |
| Камера не инициализируется | Требуется полный перезапуск (power off/on) |
| Частые реконнекты | Проверьте качество WiFi сигнала, увеличьте размер буфера |
| Captive portal не открывается | Откройте вручную: http://wheelbot-cam.local |


# Лицензия

[Не коммерческое использование](./LICENSE-NC)

[Коммерческое использование](./LICENSE-COMMERCIAL)


